#!/bin/sh

# prepare-commit-msg hook script

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

PREFIX_REGEX="^JIRA-[0-9]+"

# Function to add prefix if not present
add_prefix() {
  local msg_file=$1
  local prefix="JIRA-XXXX"  # Default prefix, replace with your desired default

  # Read the first line of the commit message
  local first_line=$(head -n 1 "$msg_file")

  # Check if the first line matches the PREFIX_REGEX
  if ! echo "$first_line" | grep -qE "$PREFIX_REGEX"; then
    # Prepend the prefix if it does not match
    echo "$prefix: $first_line" > "$msg_file"
    tail -n +2 "$msg_file" >> "$msg_file.tmp"
    mv "$msg_file.tmp" "$msg_file"
  fi
}

# Only modify commit message for commit or amend (not for merges)
if [ "$COMMIT_SOURCE" != "merge" ]; then
  add_prefix "$COMMIT_MSG_FILE"
fi

exit 0
